#define main DUMMY_MAIN
#include "main.c"
#undef main

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <stdint.h>

int test_cnt = 0;
#define TITLE(...)      test_cnt++; printf("# Test %d (L%d): ", test_cnt, __LINE__), printf(__VA_ARGS__)

void
test(int l, char* orig, int len, int expected_ret)
{
	char* pbuf[1500];
	int ret = 0;
	clock_t start, end;
	start = clock();
	for (int i=0; i<l; i++)
	{
		memcpy(pbuf, orig, 1500);
		ret = check_packet(0, pbuf, len);
	}
	end = clock();
	double time_taken = ((double)end - start) / CLOCKS_PER_SEC;

	printf(" * Last return: %d, Expected return: %d Test: %s, ", ret, expected_ret, (ret == expected_ret)?"Success":"Failed");
	printf("Time taken: %f seconds. %f pps.\n\n", time_taken, (float)l/time_taken);
}

int
main(int argc, char *argv[])
{
	if (argc != 2)
	{
		fprintf(stderr, "usage: test <loop_cnt>\n");

		exit(1);
	}

	int l = atoi(argv[1]);
	new_mss4 = htons(1300);
	new_mss6 = htons(1280);

	unsigned int len;

#if !defined NO_VLAN
	TITLE("rewrite %d 802.1Q(10,20) TCP SYN packets with MSS 1400\n", l);
	len = 68;
	char pbufdvlan[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x81, 0x00, 0x00, 0x0a, 0x81, 0x00, 0x00, 0x14,
	     0x08, 0x00, 0x45, 0x00, 0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8,
	     0x09, 0x01, 0xc0, 0xa8, 0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f,
	     0x38, 0xb5, 0x60, 0x02, 0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x05, 0x78, 0x00, 0x00 };
	test(l, pbufdvlan, len, 1);

	TITLE("rewrite %d 802.1ad(10), 802.1q(20) TCP SYN packets with MSS 1400\n", l);
	len = 68;
	char pbufadvlan[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x88, 0xa8, 0x00, 0x0a, 0x81, 0x00, 0x00, 0x14,
	     0x08, 0x00, 0x45, 0x00, 0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8,
	     0x09, 0x01, 0xc0, 0xa8, 0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f,
	     0x38, 0xb5, 0x60, 0x02, 0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x05, 0x78, 0x00, 0x00 };
	test(l, pbufadvlan, len, 1);

	TITLE("rewrite %d 802.1Q9100(10), 802.1q(20) TCP SYN packets with MSS 1400\n", l);
	len = 68;
	char pbufqqvlan[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x91, 0x00, 0x00, 0x0a, 0x81, 0x00, 0x00, 0x14,
	     0x08, 0x00, 0x45, 0x00, 0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8,
	     0x09, 0x01, 0xc0, 0xa8, 0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f,
	     0x38, 0xb5, 0x60, 0x02, 0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x05, 0x78, 0x00, 0x00 };
	test(l, pbufqqvlan, len, 1);

	TITLE("rewrite %d 802.1Q(10) TCP SYN packets with MSS 1400\n", l);
	len = 64;
	char pbufvlan[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x81, 0x00, 0x00, 0x0a, 
	     0x08, 0x00, 0x45, 0x00, 0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8,
	     0x09, 0x01, 0xc0, 0xa8, 0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f,
	     0x38, 0xb5, 0x60, 0x02, 0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x05, 0x78, 0x00, 0x00 };
	test(l, pbufvlan, len, 1);
#endif

	TITLE("rewrite %d TCP SYN packets with 2NOP MSS 1400\n", l);
	len = 60;
	char pbuf0[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x08, 0x00, 0x45, 0x00,
	     0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8, 0x09, 0x01, 0xc0, 0xa8,
	     0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f, 0x38, 0xb5, 0x60, 0x02,
	     0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x01, 0x01, 0x02, 0x04, 0x05, 0x78 };
	test(l, pbuf0, len, 1);

	TITLE("rewrite %d TCP SYN packets with MSS 1400\n", l);
	len = 60;
	char pbuf1[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x08, 0x00, 0x45, 0x00,
	     0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8, 0x09, 0x01, 0xc0, 0xa8,
	     0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f, 0x38, 0xb5, 0x60, 0x02,
	     0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x05, 0x78, 0x00, 0x00 };
	test(l, pbuf1, len, 1);

	TITLE("rewrite %d TCP SYN+ACK packets with MSS 1400\n", l);
	len = 60;
	char pbufsa[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x08, 0x00, 0x45, 0x00,
	     0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8, 0x09, 0x01, 0xc0, 0xa8,
	     0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f, 0x38, 0xb5, 0x60, 0x12,
	     0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x05, 0x78, 0x00, 0x00 };
	test(l, pbufsa, len, 1);

	TITLE("non-rewrite %d TCP SYN packets with MSS 1000\n", l);
	len = 60;
	char pbuf2[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x08, 0x00, 0x45, 0x00,
	     0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8, 0x09, 0x01, 0xc0, 0xa8,
	     0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f, 0x38, 0xb5, 0x60, 0x02,
	     0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x03, 0x38, 0x00, 0x00 };
	test(l, pbuf2, len, 0);

	TITLE("non-rewrite %d TCP FIN packets with MSS 1000\n", l);
	len = 60;
	char pbuf3[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x08, 0x00, 0x45, 0x00,
	     0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x06, 0xde, 0x20, 0xc0, 0xa8, 0x09, 0x01, 0xc0, 0xa8,
	     0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f, 0x38, 0xb5, 0x60, 0x01,
	     0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x03, 0x38, 0x00, 0x00 };
	test(l, pbuf3, len, 0);

	TITLE("non-rewrite %d Non-TCP packets\n", l);
	len = 60;
	char pbuf4[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x08, 0x00, 0x45, 0x00,
	     0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x05, 0xde, 0x20, 0xc0, 0xa8, 0x09, 0x01, 0xc0, 0xa8,
	     0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f, 0x38, 0xb5, 0x60, 0x01,
	     0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x03, 0x38, 0x00, 0x00 };
	test(l, pbuf4, len, 0);

	TITLE("non-rewrite %d Non-IP packets\n", l);
	len = 60;
	char pbuf5[1500] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0c, 0x29, 0x00, 0x15, 0xcb, 0x08, 0x01, 0x45, 0x00,
	     0x00, 0x2c, 0x09, 0x58, 0x00, 0x00, 0x40, 0x05, 0xde, 0x20, 0xc0, 0xa8, 0x09, 0x01, 0xc0, 0xa8,
	     0x09, 0x02, 0x0d, 0x1e, 0x00, 0x50, 0x44, 0xbf, 0xf8, 0x38, 0x61, 0x7f, 0x38, 0xb5, 0x60, 0x01,
	     0x02, 0x00, 0x1e, 0x74, 0x00, 0x00, 0x02, 0x04, 0x03, 0x38, 0x00, 0x00 };
	test(l, pbuf5, len, 0);

	return 0;
}
